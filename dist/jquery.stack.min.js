/*
 *  Stack JS - v0.1
 *  Stack visualisation library based on Raphael
 *  
 *
 *  By Deloitte Digital
 *  http://deloittedigital.co.uk
 */

!function(a,b){"use strict";function c(c,f){var g,h=this;this.element=c,this.$element=a(c),this.options=a.extend({},e,f),this._defaults=e,this._name=d,b.Raphael?this.init():(g=a.getScript(this.options.raphaelUrl),g.done(function(){h.init()}),g.fail(function(){throw new Error(h._name+": Raphael is not loaded, cannot proceed")}))}var d="Stack",e={debug:!0,raphaelUrl:"http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js",events:!0,version:"0.1",coefficient:1,hasContainer:!1};c.prototype.init=function(){return console.log(this),this.$element.is(":visible")===!1?(this.$element.attrchange({trackValues:!0,callback:this.checkVisibility,context:this}),!1):(console.log(this.$element),this.posLeft=this.$element.position().left,this.posTop=this.$element.position().top,this.posWidth=this.$element.width(),this.posHeight=this.$element.height(),(0===this.posHeight||0===this.posWidth)&&this.debugMessage("Element width or height are not set","warn"),this.paper=b.Raphael(this.posLeft,this.posTop,this.posWidth,this.posHeight),this.render(),this.options.events&&this.listenToEvents(),void 0)},c.prototype.render=function(){var a,b=this.options.stacks;this.totalPercentage=0,this.stacks=[];for(a in b)b.hasOwnProperty(a)&&this.drawStack(b[a])},c.prototype.drawStack=function(a){var b,c,d=this.totalPercentage*this.options.coefficient;for(c=this.stacks[this.stacks.length]=[],b=d;b<=d+a.percentage*this.options.coefficient-1;b++)this.drawEllipse(c,a,b);this.totalPercentage+=a.percentage},c.prototype.drawEllipse=function(a,b,c){var d,e=this.posWidth/6,f=this.posHeight/6,g=this.posWidth/2-e,h=this.posWidth/12,i=this.posWidth/2,j=this.posHeight-h-f,k=this.totalPercentage+b.percentage-1,l=b.primaryColor,m=b.strokeColor||b.primaryColor;d=this.paper.ellipse(i,j-c,g,h),console.log(c,k*this.options.coefficient),c===Math.floor(k*this.options.coefficient)&&(l=b.secondaryColor||b.primaryColor,m=b.strokeColor||b.secondaryColor||b.primaryColor),d.attr({stroke:m}),d.attr({fill:l,"fill-opacity":b.opacity||1}),a.push(d)},c.prototype.listenToEvents=function(){this.$element.on("stack:animate",function(a,b,c){console.log("got it",b,c,a),console.log(this)})},c.prototype.checkVisibility=function(a,b){if(console.log(this,b),"style"===a.attributeName)if("display: inline-block;"===a.newValue||"display: block;"===a.newValue)b.init();else{if("display: none;"!==a.newValue)return!1;b.paper.forEach(function(a){a.hide()})}},c.prototype.debugMessage=function(a,c){var d=c||"log";this.options.debug&&b.console[d](a,this.element)},a.fn[d]=function(b){return this.each(function(){a.data(this,"plugin_"+d)||a.data(this,"plugin_"+d,new c(this,b))})}}(jQuery,window,document),function(a){function b(){var a=document.createElement("p"),b=!1;if(a.addEventListener)a.addEventListener("DOMAttrModified",function(){b=!0},!1);else{if(!a.attachEvent)return!1;a.attachEvent("onDOMAttrModified",function(){b=!0})}return a.setAttribute("id","target"),b}function c(b,c){if(b){var d=this.data("attr-old-value");if(c.attributeName.indexOf("style")>=0){d.style||(d.style={});var e=c.attributeName.split(".");c.attributeName=e[0],c.oldValue=d.style[e[1]],c.newValue=e[1]+":"+this.prop("style")[a.camelCase(e[1])],d.style[e[1]]=c.newValue}else c.oldValue=d[c.attributeName],c.newValue=this.attr(c.attributeName),d[c.attributeName]=c.newValue;this.data("attr-old-value",d)}}var d=window.MutationObserver||window.WebKitMutationObserver;a.fn.attrchange=function(e){var f={trackValues:!1,callback:a.noop,context:this};if("function"==typeof e?f.callback=e:a.extend(f,e),f.trackValues&&a(this).each(function(b,c){for(var d,e={},b=0,f=c.attributes,g=f.length;g>b;b++)d=f.item(b),e[d.nodeName]=d.value;a(this).data("attr-old-value",e)}),d){var g={subtree:!1,attributes:!0,attributeOldValue:f.trackValues},h=new d(function(b){b.forEach(function(b){var c=b.target;f.trackValues&&(b.newValue=a(c).attr(b.attributeName)),f.callback.call(c,b,f.context)})});return this.each(function(){h.observe(this,g)})}return b()?this.on("DOMAttrModified",function(a){a.originalEvent&&(a=a.originalEvent),a.attributeName=a.attrName,a.oldValue=a.prevValue,f.callback.call(this,a,f.context)}):"onpropertychange"in document.body?this.on("propertychange",function(b){b.attributeName=window.event.propertyName,c.call(a(this),f.trackValues,b,f.context),f.callback.call(this,b,f.context)}):this}}(jQuery),function(a){function b(){var a=document.createElement("p"),b=!1;if(a.addEventListener)a.addEventListener("DOMAttrModified",function(){b=!0},!1);else{if(!a.attachEvent)return!1;a.attachEvent("onDOMAttrModified",function(){b=!0})}return a.setAttribute("id","target"),b}function c(b,c){if(b){var d=this.data("attr-old-value");if(c.attributeName.indexOf("style")>=0){d.style||(d.style={});var e=c.attributeName.split(".");c.attributeName=e[0],c.oldValue=d.style[e[1]],c.newValue=e[1]+":"+this.prop("style")[a.camelCase(e[1])],d.style[e[1]]=c.newValue}else c.oldValue=d[c.attributeName],c.newValue=this.attr(c.attributeName),d[c.attributeName]=c.newValue;this.data("attr-old-value",d)}}var d=window.MutationObserver||window.WebKitMutationObserver;a.fn.attrchange=function(e){var f={trackValues:!1,callback:a.noop,context:this};if("function"==typeof e?f.callback=e:a.extend(f,e),f.trackValues&&a(this).each(function(b,c){for(var d,e={},b=0,f=c.attributes,g=f.length;g>b;b++)d=f.item(b),e[d.nodeName]=d.value;a(this).data("attr-old-value",e)}),d){var g={subtree:!1,attributes:!0,attributeOldValue:f.trackValues},h=new d(function(b){b.forEach(function(b){var c=b.target;f.trackValues&&(b.newValue=a(c).attr(b.attributeName)),f.callback.call(c,b,f.context)})});return this.each(function(){h.observe(this,g)})}return b()?this.on("DOMAttrModified",function(a){a.originalEvent&&(a=a.originalEvent),a.attributeName=a.attrName,a.oldValue=a.prevValue,f.callback.call(this,a,f.context)}):"onpropertychange"in document.body?this.on("propertychange",function(b){b.attributeName=window.event.propertyName,c.call(a(this),f.trackValues,b,f.context),f.callback.call(this,b,f.context)}):this}}(jQuery);